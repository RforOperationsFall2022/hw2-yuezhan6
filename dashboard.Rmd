---
title: "Stocks Dashboard"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    # vertical_layout: scroll
runtime: shiny
---

```{r context="setup", include=FALSE}
library(flexdashboard)
library(shiny)
library(ggplot2)
library(dplyr)
library(readr)
library(dygraphs)
library(xts)

# import data from csv files
data_aapl <- read_csv("./stocks/AAPL_2006-01-01_to_2018-01-01.csv")
data_amzn <- read_csv("./stocks/AMZN_2006-01-01_to_2018-01-01.csv")
data_googl <- read_csv("./stocks/GOOGL_2006-01-01_to_2018-01-01.csv")
data_ibm <- read_csv("./stocks/IBM_2006-01-01_to_2018-01-01.csv")

data_stocks <- rbind(data_aapl, data_amzn, data_googl, data_ibm)

data_stocks.load <- data_stocks %>%
  mutate(Date = as.Date(Date, format="%Y-%m-%d"),
         Company = ifelse(Name == "AAPL", "Apple",
                   ifelse(Name == "AMZN", "Amazon",
                   ifelse(Name == "GOOGL", "Google",
                   "IBM"))))

# data_aapl_ts <- xts(data_aapl, )
data_aapl_xts <- as.xts(data_aapl, order.by=data_aapl$Date, dateFormat="POSIXct")
data_amzn_xts <- as.xts(data_amzn, order.by=data_amzn$Date, dateFormat="POSIXct")
data_googl_xts <- as.xts(data_googl, order.by=data_googl$Date, dateFormat="POSIXct")
data_ibm_xts <- as.xts(data_ibm, order.by=data_ibm$Date, dateFormat="POSIXct")
```

Inputs {.sidebar}
-----------------------------------------------------------------------

```{r}
checkboxGroupInput("cp", "Companies", choices = c("Apple", "Amazon", "Google", "IBM"),
                   selected = c("Apple"), inline = FALSE
                   )

dateRangeInput("dr", "Choose Date Range:",
          start = "2009-10-31",
          end   = "2010-10-31",
          min   = "2006-01-01",
          max   = "2017-12-31",
          format = "mm/dd/yy",
          startview = 'year',
          separator = " - ")

radioButtons("plot_type", "Stocks plot type", 
             choices = c("Line plot", "Violin plot"), selected = c("Line plot"))

checkboxGroupInput("price", "Choose prices", choices = c("Open", "High", "Low", "Close"),
                   selected = c("High", "Low"), inline = FALSE
                   )
```

Row
-----------------------------------------------------------------------

### Avg. Volume {.value-box}

```{r}
stocks_subset <- reactive({
  data_stocks.load %>%
    filter(
      Date >= input$dr[1],
      Date <= input$dr[2],
      Company %in% input$cp
    )
})

# Emit the download rate
renderValueBox({
  avg.volume <- mean(stocks_subset()$Volume)  # format(round(as.numeric(avg.volume), 1), nsmall=1, big.mark=",")
  valueBox(
    value = format(round(as.numeric(avg.volume), 1), nsmall=1, big.mark=","),
    icon = "fa-area-chart",
  )
})
```

### Highest Price {.value-box}

```{r}

# Emit the download rate
renderValueBox({
  price.range.top <- max(stocks_subset()$High)  # format(round(as.numeric(avg.volume), 1), nsmall=1, big.mark=",")
  valueBox(                                     # price.range.low <- min(stocks_subset()$Low)
    value = round(price.range.top,2),
    icon = "fa-arrow-up",
  )
})
```


### Lowest Price {.value-box}

```{r}

# Emit the download rate
renderValueBox({
  price.range.low <- min(stocks_subset()$Low)  # format(round(as.numeric(avg.volume), 1), nsmall=1, big.mark=",")
  valueBox(                                     # price.range.low <- min(stocks_subset()$Low)
    value = round(price.range.low,2),
    icon = "fa-arrow-down",
  )
})
```


Row 
-------------------------------------

### Graph

```{r}


```

### Price Table

```{r}
DT::renderDataTable(
  subset(stocks_subset(), select = c(Name, Date, Open, High, Low, Close, Volume))
  )
```

Row {.tabset .tabset-fade}
-------------------------------------

### Apple

```{r}
renderDygraph({
  dygraph(subset(data_aapl_xts, select = input$price), main="Stock Price") %>%
    dyRangeSelector(dateWindow = c(input$dr[1], input$dr[2]))
})
```

### Amazon

```{r}
renderDygraph({
  dygraph(subset(data_amzn_xts, select = input$price), main="Stock Price") %>%
    dyRangeSelector(dateWindow = c(input$dr[1], input$dr[2]))
})
```

### Google

```{r}
renderDygraph({
  dygraph(subset(data_googl_xts, select = input$price), main="Stock Price") %>%
    dyRangeSelector(dateWindow = c(input$dr[1], input$dr[2]))
})
```

### IBM

```{r}
renderDygraph({
  dygraph(subset(data_ibm_xts, select = input$price), main="Stock Price") %>%
    dyRangeSelector(dateWindow = c(input$dr[1], input$dr[2]))
})
```
